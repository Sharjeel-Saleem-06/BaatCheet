// ============================================
// BaatCheet Database Schema
// PostgreSQL with Prisma ORM
// Phase 4: Clerk Auth, Production Ready
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Model (Clerk Integrated)
// ============================================
model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique @map("clerk_id") // Clerk user ID
  email         String   @unique
  username      String?  @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  avatar        String?
  
  // Role-based access control
  role          UserRole @default(user)
  
  // Preferences stored as JSON
  preferences   Json     @default("{\"theme\": \"dark\", \"defaultModel\": \"llama-3.3-70b-versatile\", \"language\": \"en\"}")
  
  // Tier for rate limiting
  tier          String   @default("free") // free, pro, enterprise
  
  // Account status
  isActive      Boolean  @default(true) @map("is_active")
  isBanned      Boolean  @default(false) @map("is_banned")
  banReason     String?  @map("ban_reason")
  
  // Metadata
  lastLoginAt   DateTime? @map("last_login_at")
  loginCount    Int       @default(0) @map("login_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  conversations Conversation[]
  projects      Project[]
  templates     Template[]
  shareLinks    ShareLink[]
  audioFiles    Audio[]
  analytics     Analytics[]
  webhooks      Webhook[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]
  
  // Memory System Relations
  profile       UserProfile?
  facts         UserFact[]
  conversationSummaries ConversationSummary[]
  
  @@index([clerkId])
  @@index([email])
  @@map("users")
}

// ============================================
// Audit Log Model (Security)
// ============================================
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String   // login, logout, create, update, delete, etc.
  resource  String   // conversation, message, project, etc.
  resourceId String? @map("resource_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  metadata  Json?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Project Model
// ============================================
model Project {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  color       String   @default("#1e293b")
  icon        String   @default("folder")
  isDefault   Boolean  @default(false) @map("is_default")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  
  @@index([userId])
  @@map("projects")
}

// ============================================
// Conversation Model
// ============================================
model Conversation {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  projectId    String?  @map("project_id")
  title        String   @default("New Conversation")
  systemPrompt String?  @map("system_prompt")
  model        String   @default("llama-3.3-70b-versatile")
  tags         String[] @default([])
  isArchived   Boolean  @default(false) @map("is_archived")
  isPinned     Boolean  @default(false) @map("is_pinned")
  rating       Int?     @default(0)
  totalTokens  Int      @default(0) @map("total_tokens")
  lastAccessedAt DateTime? @map("last_accessed_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  messages    Message[]
  shareLinks  ShareLink[]
  audioFiles  Audio[]
  attachments Attachment[]
  summary     ConversationSummary?
  
  @@index([userId])
  @@index([projectId])
  @@index([userId, updatedAt])
  @@index([userId, isArchived])
  @@map("conversations")
}

// ============================================
// Message Model
// ============================================
model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           Role
  content        String
  model          String?
  tokens         Int      @default(0)
  isEdited       Boolean  @default(false) @map("is_edited")
  audioId        String?  @map("audio_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attachments  Attachment[]
  audio        Audio?       @relation(fields: [audioId], references: [id])
  
  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================
// Attachment Model
// ============================================
model Attachment {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  messageId       String?        @map("message_id")
  conversationId  String?        @map("conversation_id")
  type            AttachmentType
  originalName    String?        @map("original_name")
  storedName      String?        @map("stored_name")
  url             String
  fileSize        Int?           @map("file_size")
  mimeType        String?        @map("mime_type")
  extractedText   String?        @map("extracted_text")
  analysisResult  String?        @map("analysis_result")
  status          String         @default("processing") // processing, completed, failed
  metadata        Json?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  message      Message?      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([messageId])
  @@index([conversationId])
  @@index([status])
  @@map("attachments")
}

// ============================================
// Audio Model (Voice Input)
// ============================================
model Audio {
  id               String  @id @default(uuid())
  userId           String  @map("user_id")
  conversationId   String? @map("conversation_id")
  originalFilename String  @map("original_filename")
  storedFilename   String  @map("stored_filename")
  fileSize         Int     @map("file_size")
  duration         Float?  // seconds
  format           String  // mp3, wav, ogg, webm
  storageUrl       String  @map("storage_url")
  transcription    String?
  detectedLanguage String? @map("detected_language")
  confidence       Float?
  transcriptionModel String? @map("transcription_model")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  messages     Message[]
  
  @@index([userId])
  @@index([conversationId])
  @@map("audio_files")
}

// ============================================
// Share Link Model
// ============================================
model ShareLink {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  shareId        String    @unique @map("share_id")
  expiresAt      DateTime? @map("expires_at")
  isPublic       Boolean   @default(true) @map("is_public")
  accessCount    Int       @default(0) @map("access_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([shareId])
  @@index([userId])
  @@map("share_links")
}

// ============================================
// Template Model
// ============================================
model Template {
  id           String  @id @default(uuid())
  userId       String? @map("user_id")
  name         String
  description  String?
  systemPrompt String  @map("system_prompt")
  category     String  @default("general")
  icon         String  @default("message-square")
  isDefault    Boolean @default(false) @map("is_default")
  isPublic     Boolean @default(false) @map("is_public")
  usageCount   Int     @default(0) @map("usage_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([category])
  @@index([isDefault])
  @@map("templates")
}

// ============================================
// Analytics Model
// ============================================
model Analytics {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  date                  DateTime @db.Date
  messagesCount         Int      @default(0) @map("messages_count")
  responsesCount        Int      @default(0) @map("responses_count")
  tokensByModel         Json     @default("{}") @map("tokens_by_model")
  conversationsCreated  Int      @default(0) @map("conversations_created")
  projectsCreated       Int      @default(0) @map("projects_created")
  imagesUploaded        Int      @default(0) @map("images_uploaded")
  audioTranscribed      Float    @default(0) @map("audio_transcribed") // minutes
  exportsGenerated      Int      @default(0) @map("exports_generated")
  searchesPerformed     Int      @default(0) @map("searches_performed")
  averageResponseTime   Float    @default(0) @map("avg_response_time") // ms
  topTags               String[] @default([]) @map("top_tags")
  topModels             String[] @default([]) @map("top_models")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId, date])
  @@map("analytics")
}

// ============================================
// Webhook Model
// ============================================
model Webhook {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  url          String
  events       String[]  @default([])
  secret       String
  isActive     Boolean   @default(true) @map("is_active")
  failureCount Int       @default(0) @map("failure_count")
  lastTriggered DateTime? @map("last_triggered")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]
  
  @@index([userId])
  @@map("webhooks")
}

// ============================================
// Webhook Delivery Model
// ============================================
model WebhookDelivery {
  id           String   @id @default(uuid())
  webhookId    String   @map("webhook_id")
  event        String
  payload      Json
  status       String   // pending, success, failed
  statusCode   Int?     @map("status_code")
  response     String?
  attempts     Int      @default(0)
  nextRetry    DateTime? @map("next_retry")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@index([webhookId])
  @@index([status])
  @@map("webhook_deliveries")
}

// ============================================
// API Key Model
// ============================================
model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String
  keyHash     String    @map("key_hash")
  keyPrefix   String    @map("key_prefix") // First 8 chars for identification
  permissions String[]  @default(["read", "write"])
  rateLimit   Int       @default(100) @map("rate_limit") // requests per hour
  lastUsed    DateTime? @map("last_used")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  usageCount  Int       @default(0) @map("usage_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([keyPrefix])
  @@map("api_keys")
}

// ============================================
// API Key Usage Tracking
// ============================================
model ApiKeyUsage {
  id           String   @id @default(uuid())
  provider     String
  keyIndex     Int      @map("key_index")
  requestCount Int      @default(0) @map("request_count")
  date         DateTime @default(now()) @db.Date
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([provider, keyIndex, date])
  @@index([provider, date])
  @@map("api_key_usage")
}

// ============================================
// Rate Limit Tracking
// ============================================
model RateLimit {
  id          String   @id @default(uuid())
  identifier  String   // IP address or user ID
  endpoint    String
  count       Int      @default(0)
  windowStart DateTime @map("window_start")
  
  @@unique([identifier, endpoint, windowStart])
  @@index([identifier, endpoint])
  @@map("rate_limits")
}

// ============================================
// Flagged Content (Content Moderation)
// ============================================
model FlaggedContent {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  messageId      String?   @map("message_id")
  reason         String    // spam, abuse, inappropriate, other
  severity       String    @default("medium") // low, medium, high, critical
  flaggedBy      String    @map("flagged_by") // Admin user ID
  status         String    @default("pending") // pending, reviewed, actioned, dismissed
  reviewedBy     String?   @map("reviewed_by")
  reviewedAt     DateTime? @map("reviewed_at")
  action         String?   // deleted, warned, none
  notes          String?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([status])
  @@index([severity])
  @@index([conversationId])
  @@map("flagged_content")
}

// ============================================
// System Settings
// ============================================
model SystemSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedBy String?  @map("updated_by")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

// ============================================
// API Usage Tracking (for Admin Analytics)
// ============================================
model ApiUsageLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  provider  String   // groq, openrouter, deepseek, etc.
  model     String
  endpoint  String
  tokens    Int      @default(0)
  cost      Float    @default(0)
  latency   Int      @default(0) // milliseconds
  status    String   // success, error, rate_limited
  errorMsg  String?  @map("error_msg")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([provider])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ============================================
// Enums
// ============================================
enum Role {
  system
  user
  assistant
}

enum AttachmentType {
  image
  document
}

enum UserRole {
  user
  moderator
  admin
}

// ============================================
// User Profile & Memory System
// ============================================

// Long-term user profile with learned preferences
model UserProfile {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Core identity facts
  fullName      String?  @map("full_name")
  preferredName String?  @map("preferred_name")
  occupation    String?
  education     String?
  location      String?
  
  // Preferences & Interests (JSON arrays/objects)
  interests     Json     @default("[]")  // ["AI", "coding", "fitness"]
  preferences   Json     @default("{}")  // { tone: "casual", detailLevel: "detailed" }
  expertise     Json     @default("[]")  // ["Python", "React", "DevOps"]
  goals         Json     @default("[]")  // ["Learn AI", "Build startup"]
  
  // Communication style
  preferredLanguage String @default("auto") @map("preferred_language")  // "english", "roman-urdu", "mixed"
  communicationTone String @default("friendly") @map("communication_tone")  // "professional", "casual", "friendly"
  responseStyle     String @default("balanced") @map("response_style")  // "concise", "balanced", "comprehensive"
  
  // Usage patterns
  primaryUseCase    String?  @map("primary_use_case")  // "coding", "learning", "business", "creative"
  typicalQuestions  Json     @default("[]") @map("typical_questions")
  
  // Metadata
  factCount      Int      @default(0) @map("fact_count")
  lastUpdated    DateTime @updatedAt @map("last_updated")
  createdAt      DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@map("user_profiles")
}

// Individual facts learned about users
model UserFact {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category       String    // "personal", "professional", "preference", "goal", "skill", "interest", "relationship"
  factType       String    @map("fact_type")  // "name", "occupation", "interest", "skill", etc.
  factKey        String    @map("fact_key")   // "preferred_name", "occupation", etc.
  factValue      String    @map("fact_value") @db.Text  // Actual value
  confidence     Float     @default(1.0)  // 0-1 confidence score
  source         String    // "explicit" (user told us) or "inferred" (we detected)
  
  conversationId String?   @map("conversation_id")  // Where this fact was learned
  timestamp      DateTime  @default(now())
  expiresAt      DateTime? @map("expires_at")  // Optional expiry for temporary facts
  isActive       Boolean   @default(true) @map("is_active")
  
  // For skill tracking
  skillLevel     String?   @map("skill_level")  // "beginner", "intermediate", "advanced", "expert"
  
  // For goal tracking
  goalStatus     String?   @map("goal_status")  // "active", "completed", "abandoned"
  goalProgress   String?   @map("goal_progress")  // "just_started", "making_progress", "advanced"
  
  @@index([userId, isActive])
  @@index([userId, category])
  @@index([category])
  @@index([factKey])
  @@map("user_facts")
}

// Conversation summaries for continuity
model ConversationSummary {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String       @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  title           String
  summary         String       @db.Text  // Brief summary of user's messages
  keyTopics       Json         @default("[]") @map("key_topics")  // ["Python", "API", "deployment"]
  mainIntent      String       @map("main_intent")  // "learning", "problem_solving", "brainstorming", "creative", "planning"
  
  messageCount    Int          @map("message_count")
  userMessages    Json         @default("[]") @map("user_messages")  // Array of user message snippets
  timestamp       DateTime     @default(now())
  
  @@unique([conversationId])
  @@index([userId, timestamp])
  @@index([conversationId])
  @@map("conversation_summaries")
}
