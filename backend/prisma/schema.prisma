// ============================================
// BaatCheet Database Schema
// PostgreSQL with Prisma ORM
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Model
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  
  // Preferences stored as JSON
  preferences Json @default("{\"theme\": \"dark\", \"defaultModel\": \"llama-3.1-70b-versatile\", \"language\": \"en\"}")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  conversations Conversation[]
  projects      Project[]
  
  @@map("users")
}

// ============================================
// Project Model (for organizing conversations)
// ============================================
model Project {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  color       String   @default("#1e293b")
  icon        String   @default("folder")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  
  @@index([userId])
  @@map("projects")
}

// ============================================
// Conversation Model
// ============================================
model Conversation {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  projectId    String?  @map("project_id")
  title        String   @default("New Conversation")
  systemPrompt String?  @map("system_prompt")
  model        String   @default("llama-3.1-70b-versatile")
  tags         String[] @default([])
  isArchived   Boolean  @default(false) @map("is_archived")
  isPinned     Boolean  @default(false) @map("is_pinned")
  totalTokens  Int      @default(0) @map("total_tokens")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  messages Message[]
  
  @@index([userId])
  @@index([projectId])
  @@index([userId, updatedAt])
  @@map("conversations")
}

// ============================================
// Message Model
// ============================================
model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           Role
  content        String
  model          String?
  tokens         Int      @default(0)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attachments  Attachment[]
  
  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================
// Attachment Model (for images/documents)
// ============================================
model Attachment {
  id            String  @id @default(uuid())
  messageId     String  @map("message_id")
  type          AttachmentType
  url           String
  extractedText String? @map("extracted_text")
  metadata      Json?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@map("attachments")
}

// ============================================
// API Key Usage Tracking
// ============================================
model ApiKeyUsage {
  id           String   @id @default(uuid())
  provider     String   // groq, together, deepseek
  keyIndex     Int      @map("key_index")
  requestCount Int      @default(0) @map("request_count")
  date         DateTime @default(now()) @db.Date
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([provider, keyIndex, date])
  @@index([provider, date])
  @@map("api_key_usage")
}

// ============================================
// Enums
// ============================================
enum Role {
  system
  user
  assistant
}

enum AttachmentType {
  image
  document
}
