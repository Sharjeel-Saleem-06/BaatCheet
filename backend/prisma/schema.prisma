// ============================================
// BaatCheet Database Schema
// PostgreSQL with Prisma ORM
// Phase 4: Clerk Auth, Production Ready
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Model (Clerk Integrated)
// ============================================
model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique @map("clerk_id") // Clerk user ID
  email         String   @unique
  username      String?  @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  avatar        String?
  
  // Role-based access control
  role          UserRole @default(user)
  
  // Preferences stored as JSON
  preferences   Json     @default("{\"theme\": \"dark\", \"defaultModel\": \"llama-3.3-70b-versatile\", \"language\": \"en\"}")
  
  // Tier for rate limiting
  tier          String   @default("free") // free, pro, enterprise
  
  // Account status
  isActive      Boolean  @default(true) @map("is_active")
  isBanned      Boolean  @default(false) @map("is_banned")
  banReason     String?  @map("ban_reason")
  
  // Metadata
  lastLoginAt   DateTime? @map("last_login_at")
  loginCount    Int       @default(0) @map("login_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  conversations Conversation[]
  projects      Project[]
  templates     Template[]
  shareLinks    ShareLink[]
  audioFiles    Audio[]
  analytics     Analytics[]
  webhooks      Webhook[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]
  
  // Memory System Relations
  profile       UserProfile?
  facts         UserFact[]
  conversationSummaries ConversationSummary[]
  
  // Image Generation Relations
  imageGenerations ImageGeneration[]
  imageQuota       ImageGenerationQuota?
  
  @@index([clerkId])
  @@index([email])
  @@map("users")
}

// ============================================
// Audit Log Model (Security)
// ============================================
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String   // login, logout, create, update, delete, etc.
  resource  String   // conversation, message, project, etc.
  resourceId String? @map("resource_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  metadata  Json?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Project Model (Enhanced with Advanced Context)
// ============================================
model Project {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?  @db.Text  // User-provided project instructions
  color       String   @default("#1e293b")
  icon        String   @default("folder")  // Can be emoji like "ðŸ“±" or icon name
  emoji       String?  // Emoji for project (e.g., "ðŸ¤–", "ðŸ“±", "ðŸ’»")
  isDefault   Boolean  @default(false) @map("is_default")
  isArchived  Boolean  @default(false) @map("is_archived")
  
  // Advanced Project Context - AI learns what this project is about
  context           String?  @db.Text  // AI-generated summary of project scope
  keyTopics         String[] @default([]) @map("key_topics")  // Main topics discussed
  techStack         String[] @default([]) @map("tech_stack")  // Technologies mentioned
  goals             String[] @default([])  // Project goals extracted from conversations
  constraints       String[] @default([])  // Project constraints/limitations
  targetAudience    String?  @map("target_audience")  // Who is this project for
  communicationStyle String? @map("communication_style")  // formal, casual, technical
  preferredLanguage String?  @map("preferred_language")  // Response language preference
  domainExpertise   String[] @default([]) @map("domain_expertise")  // Areas of expertise needed
  customInstructions String? @db.Text @map("custom_instructions")  // Advanced custom AI instructions
  
  // Context learning metadata
  lastContextUpdate DateTime? @map("last_context_update")
  contextVersion    Int       @default(0) @map("context_version")  // Track context updates
  messageCount      Int       @default(0) @map("message_count")  // Total messages in project
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  collaborators ProjectCollaborator[]
  invitations   ProjectInvitation[]
  chatSettings  ProjectChatSettings?
  chatMessages  ProjectChatMessage[]
  
  @@index([userId])
  @@index([isArchived])
  @@map("projects")
}

// ============================================
// Project Collaboration Model
// Roles: admin (full access), moderator (edit, create, no delete), viewer (read only)
// Project creator is always admin and cannot be removed
// ============================================
model ProjectCollaborator {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  role      ProjectRole @default(viewer)  // admin, moderator, viewer
  
  // Permissions (derived from role but can be customized)
  canEdit       Boolean @default(false) @map("can_edit")
  canDelete     Boolean @default(false) @map("can_delete")
  canInvite     Boolean @default(false) @map("can_invite")
  canManageRoles Boolean @default(false) @map("can_manage_roles")
  
  addedAt   DateTime @default(now()) @map("added_at")
  addedBy   String   @map("added_by")  // User ID who added this collaborator
  
  // Activity tracking
  lastAccessedAt DateTime? @map("last_accessed_at")
  accessCount    Int       @default(0) @map("access_count")
  
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, userId])
  @@index([userId])
  @@index([projectId])
  @@index([role])
  @@map("project_collaborators")
}

enum ProjectRole {
  admin      // Full access: edit, delete, invite, manage roles
  moderator  // Can edit and create, but cannot delete or manage roles
  viewer     // Read-only access
}

// ============================================
// Project Invitation Model
// ============================================
model ProjectInvitation {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  inviterId   String   @map("inviter_id")  // User who sent invitation
  inviteeEmail String  @map("invitee_email")
  inviteeId   String?  @map("invitee_id")  // If user exists in system
  role        ProjectRole @default(viewer)  // Role to assign on acceptance
  status      String   @default("pending")  // pending, accepted, rejected, expired
  message     String?  // Optional message from inviter
  
  expiresAt   DateTime @map("expires_at")
  respondedAt DateTime? @map("responded_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([inviteeEmail])
  @@index([inviteeId])
  @@index([projectId])
  @@index([status])
  @@map("project_invitations")
}

// ============================================
// Project Chat Settings Model
// Controls who can send messages in project chat
// ============================================
model ProjectChatSettings {
  id                String   @id @default(uuid())
  projectId         String   @unique @map("project_id")
  
  // Chat access control - who can send messages
  chatAccess        ChatAccessLevel @default(all) @map("chat_access")
  
  // Feature toggles
  allowImages       Boolean  @default(true) @map("allow_images")
  allowEmojis       Boolean  @default(true) @map("allow_emojis")
  allowEditing      Boolean  @default(true) @map("allow_editing")  // Can users edit their messages
  allowDeleting     Boolean  @default(true) @map("allow_deleting")  // Can users delete their messages
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@map("project_chat_settings")
}

// Chat access levels
enum ChatAccessLevel {
  all              // All collaborators can send messages
  admin_moderator  // Only admin and moderators can send messages
  admin_only       // Only admin can send messages
}

// ============================================
// Project Chat Message Model
// Messages in project collaboration chat
// ============================================
model ProjectChatMessage {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  senderId        String   @map("sender_id")  // User ID who sent the message
  
  // Message content
  content         String   @db.Text
  messageType     ProjectMessageType @default(text) @map("message_type")
  
  // For image messages
  imageUrl        String?  @map("image_url") @db.Text
  imageThumbnail  String?  @map("image_thumbnail") @db.Text
  
  // Edit/Delete tracking
  isEdited        Boolean  @default(false) @map("is_edited")
  editedAt        DateTime? @map("edited_at")
  isDeleted       Boolean  @default(false) @map("is_deleted")
  deletedAt       DateTime? @map("deleted_at")
  deletedBy       String?  @map("deleted_by")  // User ID who deleted (for admin deletes)
  
  // Reply support
  replyToId       String?  @map("reply_to_id")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  replyTo         ProjectChatMessage? @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies         ProjectChatMessage[] @relation("MessageReplies")
  readReceipts    ProjectChatReadReceipt[]
  
  @@index([projectId, createdAt])
  @@index([senderId])
  @@index([isDeleted])
  @@map("project_chat_messages")
}

enum ProjectMessageType {
  text
  image
  system  // System messages like "User joined", "Settings changed"
}

// ============================================
// Project Chat Read Receipt Model
// Track who has read messages
// ============================================
model ProjectChatReadReceipt {
  id              String   @id @default(uuid())
  messageId       String   @map("message_id")
  userId          String   @map("user_id")
  readAt          DateTime @default(now()) @map("read_at")
  
  message         ProjectChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, userId])
  @@index([userId])
  @@map("project_chat_read_receipts")
}

// ============================================
// Project Chat Hidden Messages Model
// Track messages hidden for specific users (delete for me)
// ============================================
model ProjectChatHiddenMessage {
  id              String   @id @default(uuid())
  messageId       String   @map("message_id")
  userId          String   @map("user_id")  // User who hid this message
  hiddenAt        DateTime @default(now()) @map("hidden_at")
  
  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
  @@map("project_chat_hidden_messages")
}

// ============================================
// Message Feedback Model (Like/Dislike Learning)
// ============================================
model MessageFeedback {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  conversationId String  @map("conversation_id")
  messageId     String   @map("message_id")
  
  feedbackType  String   // like, dislike, rewrite_request
  reason        String?  // Optional reason for dislike
  originalContent String? @map("original_content") @db.Text  // Original AI response
  improvedContent String? @map("improved_content") @db.Text  // User's improved version (if rewrite)
  
  // Context for learning
  userQuery     String?  @map("user_query") @db.Text  // The user's original question
  model         String?  // Model that generated the response
  intent        String?  // Detected intent
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([feedbackType])
  @@index([model])
  @@index([createdAt])
  @@map("message_feedback")
}

// ============================================
// Conversation Model
// ============================================
model Conversation {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  projectId    String?  @map("project_id")
  title        String   @default("New Conversation")
  systemPrompt String?  @map("system_prompt")
  model        String   @default("llama-3.3-70b-versatile")
  tags         String[] @default([])
  isArchived   Boolean  @default(false) @map("is_archived")
  isPinned     Boolean  @default(false) @map("is_pinned")
  rating       Int?     @default(0)
  totalTokens  Int      @default(0) @map("total_tokens")
  lastAccessedAt DateTime? @map("last_accessed_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  messages    Message[]
  shareLinks  ShareLink[]
  audioFiles  Audio[]
  attachments Attachment[]
  summary     ConversationSummary?
  
  @@index([userId])
  @@index([projectId])
  @@index([userId, updatedAt])
  @@index([userId, isArchived])
  @@map("conversations")
}

// ============================================
// Message Model
// ============================================
model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           Role
  content        String
  model          String?
  tokens         Int      @default(0)
  isEdited       Boolean  @default(false) @map("is_edited")
  audioId        String?  @map("audio_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attachments  Attachment[]
  audio        Audio?       @relation(fields: [audioId], references: [id])
  
  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================
// Attachment Model
// ============================================
model Attachment {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  messageId       String?        @map("message_id")
  conversationId  String?        @map("conversation_id")
  type            AttachmentType
  originalName    String?        @map("original_name")
  storedName      String?        @map("stored_name")
  url             String
  fileSize        Int?           @map("file_size")
  mimeType        String?        @map("mime_type")
  extractedText   String?        @map("extracted_text")
  analysisResult  String?        @map("analysis_result")
  status          String         @default("processing") // processing, completed, failed
  metadata        Json?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  message      Message?      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([messageId])
  @@index([conversationId])
  @@index([status])
  @@map("attachments")
}

// ============================================
// Audio Model (Voice Input)
// ============================================
model Audio {
  id               String  @id @default(uuid())
  userId           String  @map("user_id")
  conversationId   String? @map("conversation_id")
  originalFilename String  @map("original_filename")
  storedFilename   String  @map("stored_filename")
  fileSize         Int     @map("file_size")
  duration         Float?  // seconds
  format           String  // mp3, wav, ogg, webm
  storageUrl       String  @map("storage_url")
  transcription    String?
  detectedLanguage String? @map("detected_language")
  confidence       Float?
  transcriptionModel String? @map("transcription_model")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  messages     Message[]
  
  @@index([userId])
  @@index([conversationId])
  @@map("audio_files")
}

// ============================================
// Share Link Model
// ============================================
model ShareLink {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  shareId        String    @unique @map("share_id")
  expiresAt      DateTime? @map("expires_at")
  isPublic       Boolean   @default(true) @map("is_public")
  accessCount    Int       @default(0) @map("access_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([shareId])
  @@index([userId])
  @@map("share_links")
}

// ============================================
// Template Model
// ============================================
model Template {
  id           String  @id @default(uuid())
  userId       String? @map("user_id")
  name         String
  description  String?
  systemPrompt String  @map("system_prompt")
  category     String  @default("general")
  icon         String  @default("message-square")
  isDefault    Boolean @default(false) @map("is_default")
  isPublic     Boolean @default(false) @map("is_public")
  usageCount   Int     @default(0) @map("usage_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([category])
  @@index([isDefault])
  @@map("templates")
}

// ============================================
// Analytics Model
// ============================================
model Analytics {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  date                  DateTime @db.Date
  messagesCount         Int      @default(0) @map("messages_count")
  responsesCount        Int      @default(0) @map("responses_count")
  tokensByModel         Json     @default("{}") @map("tokens_by_model")
  conversationsCreated  Int      @default(0) @map("conversations_created")
  projectsCreated       Int      @default(0) @map("projects_created")
  imagesUploaded        Int      @default(0) @map("images_uploaded")
  audioTranscribed      Float    @default(0) @map("audio_transcribed") // minutes
  exportsGenerated      Int      @default(0) @map("exports_generated")
  searchesPerformed     Int      @default(0) @map("searches_performed")
  averageResponseTime   Float    @default(0) @map("avg_response_time") // ms
  topTags               String[] @default([]) @map("top_tags")
  topModels             String[] @default([]) @map("top_models")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId, date])
  @@map("analytics")
}

// ============================================
// Webhook Model
// ============================================
model Webhook {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  url          String
  events       String[]  @default([])
  secret       String
  isActive     Boolean   @default(true) @map("is_active")
  failureCount Int       @default(0) @map("failure_count")
  lastTriggered DateTime? @map("last_triggered")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]
  
  @@index([userId])
  @@map("webhooks")
}

// ============================================
// Webhook Delivery Model
// ============================================
model WebhookDelivery {
  id           String   @id @default(uuid())
  webhookId    String   @map("webhook_id")
  event        String
  payload      Json
  status       String   // pending, success, failed
  statusCode   Int?     @map("status_code")
  response     String?
  attempts     Int      @default(0)
  nextRetry    DateTime? @map("next_retry")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@index([webhookId])
  @@index([status])
  @@map("webhook_deliveries")
}

// ============================================
// API Key Model
// ============================================
model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String
  keyHash     String    @map("key_hash")
  keyPrefix   String    @map("key_prefix") // First 8 chars for identification
  permissions String[]  @default(["read", "write"])
  rateLimit   Int       @default(100) @map("rate_limit") // requests per hour
  lastUsed    DateTime? @map("last_used")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  usageCount  Int       @default(0) @map("usage_count")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([keyPrefix])
  @@map("api_keys")
}

// ============================================
// API Key Usage Tracking
// ============================================
model ApiKeyUsage {
  id           String   @id @default(uuid())
  provider     String
  keyIndex     Int      @map("key_index")
  requestCount Int      @default(0) @map("request_count")
  date         DateTime @default(now()) @db.Date
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([provider, keyIndex, date])
  @@index([provider, date])
  @@map("api_key_usage")
}

// ============================================
// Rate Limit Tracking
// ============================================
model RateLimit {
  id          String   @id @default(uuid())
  identifier  String   // IP address or user ID
  endpoint    String
  count       Int      @default(0)
  windowStart DateTime @map("window_start")
  
  @@unique([identifier, endpoint, windowStart])
  @@index([identifier, endpoint])
  @@map("rate_limits")
}

// ============================================
// Flagged Content (Content Moderation)
// ============================================
model FlaggedContent {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  messageId      String?   @map("message_id")
  reason         String    // spam, abuse, inappropriate, other
  severity       String    @default("medium") // low, medium, high, critical
  flaggedBy      String    @map("flagged_by") // Admin user ID
  status         String    @default("pending") // pending, reviewed, actioned, dismissed
  reviewedBy     String?   @map("reviewed_by")
  reviewedAt     DateTime? @map("reviewed_at")
  action         String?   // deleted, warned, none
  notes          String?
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([status])
  @@index([severity])
  @@index([conversationId])
  @@map("flagged_content")
}

// ============================================
// System Settings
// ============================================
model SystemSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedBy String?  @map("updated_by")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

// ============================================
// API Usage Tracking (for Admin Analytics)
// ============================================
model ApiUsageLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  provider  String   // groq, openrouter, deepseek, etc.
  model     String
  endpoint  String
  tokens    Int      @default(0)
  cost      Float    @default(0)
  latency   Int      @default(0) // milliseconds
  status    String   // success, error, rate_limited
  errorMsg  String?  @map("error_msg")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([provider])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ============================================
// Enums
// ============================================
enum Role {
  system
  user
  assistant
}

enum AttachmentType {
  image
  document
}

enum UserRole {
  user
  moderator
  admin
}

// ============================================
// User Profile & Memory System
// ============================================

// Long-term user profile with learned preferences
model UserProfile {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Core identity facts
  fullName      String?  @map("full_name")
  preferredName String?  @map("preferred_name")
  occupation    String?
  education     String?
  location      String?
  
  // Preferences & Interests (JSON arrays/objects)
  interests     Json     @default("[]")  // ["AI", "coding", "fitness"]
  preferences   Json     @default("{}")  // { tone: "casual", detailLevel: "detailed" }
  expertise     Json     @default("[]")  // ["Python", "React", "DevOps"]
  goals         Json     @default("[]")  // ["Learn AI", "Build startup"]
  
  // Communication style
  preferredLanguage String @default("auto") @map("preferred_language")  // "english", "roman-urdu", "mixed"
  communicationTone String @default("friendly") @map("communication_tone")  // "professional", "casual", "friendly"
  responseStyle     String @default("balanced") @map("response_style")  // "concise", "balanced", "comprehensive"
  
  // Usage patterns
  primaryUseCase    String?  @map("primary_use_case")  // "coding", "learning", "business", "creative"
  typicalQuestions  Json     @default("[]") @map("typical_questions")
  
  // Custom Instructions (like ChatGPT) - applies to all non-project chats
  customInstructions String? @db.Text @map("custom_instructions")
  
  // Metadata
  factCount      Int      @default(0) @map("fact_count")
  lastUpdated    DateTime @updatedAt @map("last_updated")
  createdAt      DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@map("user_profiles")
}

// Individual facts learned about users
model UserFact {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category       String    // "personal", "professional", "preference", "goal", "skill", "interest", "relationship"
  factType       String    @map("fact_type")  // "name", "occupation", "interest", "skill", etc.
  factKey        String    @map("fact_key")   // "preferred_name", "occupation", etc.
  factValue      String    @map("fact_value") @db.Text  // Actual value
  confidence     Float     @default(1.0)  // 0-1 confidence score
  source         String    // "explicit" (user told us) or "inferred" (we detected)
  
  conversationId String?   @map("conversation_id")  // Where this fact was learned
  timestamp      DateTime  @default(now())
  expiresAt      DateTime? @map("expires_at")  // Optional expiry for temporary facts
  isActive       Boolean   @default(true) @map("is_active")
  
  // For skill tracking
  skillLevel     String?   @map("skill_level")  // "beginner", "intermediate", "advanced", "expert"
  
  // For goal tracking
  goalStatus     String?   @map("goal_status")  // "active", "completed", "abandoned"
  goalProgress   String?   @map("goal_progress")  // "just_started", "making_progress", "advanced"
  
  @@index([userId, isActive])
  @@index([userId, category])
  @@index([category])
  @@index([factKey])
  @@map("user_facts")
}

// Conversation summaries for continuity
model ConversationSummary {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String       @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  title           String
  summary         String       @db.Text  // Brief summary of user's messages
  keyTopics       Json         @default("[]") @map("key_topics")  // ["Python", "API", "deployment"]
  mainIntent      String       @map("main_intent")  // "learning", "problem_solving", "brainstorming", "creative", "planning"
  
  messageCount    Int          @map("message_count")
  userMessages    Json         @default("[]") @map("user_messages")  // Array of user message snippets
  timestamp       DateTime     @default(now())
  
  @@unique([conversationId])
  @@index([userId, timestamp])
  @@index([conversationId])
  @@map("conversation_summaries")
}

// ============================================
// Image Generation Model
// ============================================
model ImageGeneration {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId  String?  @map("conversation_id")
  
  // Request details
  prompt          String   @db.Text
  optimizedPrompt String?  @map("optimized_prompt") @db.Text
  negativePrompt  String?  @map("negative_prompt") @db.Text
  
  // Style and configuration
  style           String?  // realistic, anime, cartoon, etc.
  aspectRatio     String   @default("1:1") @map("aspect_ratio")
  seed            Int?     // For reproducibility
  
  // Model and dimensions
  model           String   // Model used for generation
  width           Int      @default(512)
  height          Int      @default(512)
  
  // Result
  status          String   @default("pending") // pending, processing, completed, failed
  imageUrl        String?  @map("image_url") @db.Text // Base64 or URL
  thumbnailUrl    String?  @map("thumbnail_url") @db.Text
  error           String?  @db.Text
  
  // Metadata
  generationTime  Int?     @map("generation_time") // milliseconds
  apiKeyUsed      String?  @map("api_key_used") // Partial key for tracking
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([status])
  @@index([conversationId])
  @@map("image_generations")
}

// ============================================
// Image Generation Quota Model
// ============================================
model ImageGenerationQuota {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dailyLimit      Int      @map("daily_limit") // Based on tier
  dailyUsed       Int      @default(0) @map("daily_used")
  lastResetDate   DateTime @default(now()) @map("last_reset_date")
  
  monthlyLimit    Int      @default(0) @map("monthly_limit")
  monthlyUsed     Int      @default(0) @map("monthly_used")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@map("image_generation_quotas")
}

// ============================================
// Pending Signup Model (for email verification)
// ============================================
model PendingSignup {
  id               String   @id @default(uuid())
  email            String   @unique
  password         String   // Hashed password (empty for password reset)
  firstName        String?  @map("first_name")
  lastName         String?  @map("last_name")
  username         String?
  verificationCode String   @map("verification_code")
  codeExpiry       DateTime @map("code_expiry")
  attempts         Int      @default(0) // Track verification attempts
  isPasswordReset  Boolean  @default(false) @map("is_password_reset") // True if this is a password reset request
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  
  @@index([email])
  @@index([verificationCode])
  @@map("pending_signups")
}
